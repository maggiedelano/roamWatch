[{"create-time":1621551186958,"title":"roamWatch",":create/user":{":user/uid":"2didgYjql9PA7QKUOsQOD9n84ms1"},"children":[{"edit-time":1621542937555,"children":[{"string":"```javascript\n// add pull watches for all blocks by a specific user and log them to\n// a specifed page\n\n// video: https://www.loom.com/share/b1936a272e3b4031b3d5a167631cc1a0\ndisplayName = \"Maggie Delano\";\npageToWatch = \"pagewatch\";\n\naddPullWatchesForUser(displayName,pageToWatch);\n\nfunction addPullWatchAtBlock(blockID,pageName){\n\n  var blockString = '[:block/uid \"' + blockID + '\"]'; \n\n  pageID = getPageIDFromPageName(pageName);\n\n  var result = roamAlphaAPI\n  .data\n  .addPullWatch(\"[{:block/_refs [:block/string :block/uid]}]\", \n                blockString, function a(before, after)\n                 {\n                  if(before === null){ // check for null / first reference\n                   newBlockRef = after[\":block/_refs\"][0][\":block/uid\"];\n                 }\n                  else { \n                   beforeUIDs = before[\":block/_refs\"].map(x => x[\":block/uid\"]);\n                   afterUIDs = after[\":block/_refs\"].map(x => x[\":block/uid\"]);\n                   newBlockRef = afterUIDs.filter(x => !beforeUIDs.includes(x));\n                  }\n\n            if (newBlockRef.length > 0){\n              window\n            .roamAlphaAPI\n            .createBlock(\n            {\"location\": \n            {\"parent-uid\": pageID, \n            \"order\": 0}, \n            \"block\": \n            {\"string\": '((' + newBlockRef + '))'}})\n            }           \n});\n\n  return result;\n}\n\nfunction removePullWatchAtBlock(blockID,pageName){\n\n  var blockString = '[:block/uid \"' + blockID + '\"]'; \n\n  pageID = getPageIDFromPageName(pageName);\n\n  var result = roamAlphaAPI\n  .data\n  .removePullWatch(\"[{:block/_refs [:block/string :block/uid]}]\", \n                blockString);\n\n  return result;\n}\n\n\nfunction getPageIDFromPageName(pageName){\n  var pageID = window.roamAlphaAPI.q(`\n  [:find ?pageID\n  :in $ ?pageName\n  :where\n    [?p :node/title ?pageName]\n    [?p :block/uid ?pageID]\n]`, pageName);\n  \n  if (pageID.length > 0)\n    return pageID[0][0];\n\n  else return [];\n}\n\nfunction findAllBlocksFromUser(displayName){\n\n\tuserID = getUserIDFromDisplayName(displayName);\n\n\tvar blocks = window.roamAlphaAPI.q(`\n  \t\t[:find ?blockUIDs\n  \t\t:in $ ?userID\n  \t\t\t:where\n    \t\t[?blocks :create/user ?userID]\n    \t\t[?blocks :block/uid ?blockUIDs]\n    \t\t(not [?blocks :node/title ?title])\n\t\t]`, userID);\n\n\treturn blocks.map((data, index) => {return data[0]});\n}\n\nfunction getUserIDFromDisplayName(displayName){\n\n\tvar userID = window.roamAlphaAPI.q(`\n\t[:find ?userID\n  \t\t:in $ ?displayName\n  \t\t:where\n    \t\t[?userID :user/display-name ?displayName]]\n\t\t`,displayName)\n\n\tif (userID.length != 0)\n\t\treturn userID[0][0];\n\telse\n\t\tconsole.log(\"No user found with name: \" + displayName);\n}\n\nfunction addPullWatchesForUser(displayName,pageName){\n\t\n\t// get an array of blockUIDs\n\tblockUIDs = findAllBlocksFromUser(displayName);\n\n\t// create page if it doesn't already exist\n\tpageID = getPageIDFromPageName(pageName);\n\t\n\tif (pageID.length == 0){\n    \tconsole.log(\"Please create page and try again\");\n\t}\n\n\telse {\n\t\t// iterate over the array to add pull watches for each block\n\t\tfor (var i = blockUIDs.length - 1; i >= 0; i--) {\n\t\t\tvar pw = addPullWatchAtBlock(blockUIDs[i],pageName);\n\t\t}\n\t}\n}\n\nfunction removePullWatchesForUser(displayName,pageName){\n\t\n\t// get an array of blockUIDs\n\tblockUIDs = findAllBlocksFromUser(displayName);\n\n\t// create page if it doesn't already exist\n\tpageID = getPageIDFromPageName(pageName);\n\t\n\tif (pageID.length == 0){\n    \tconsole.log(\"Please create page and try again\");\n\t}\n\n\telse {\n\t\t// iterate over the array to add pull watches for each block\n\t\tfor (var i = blockUIDs.length - 1; i >= 0; i--) {\n\t\t\tvar pw = removePullWatchAtBlock(blockUIDs[i],pageName);\n\t\t}\n\t}\n\n}\n```","create-time":1621542937555,"uid":"5UYZVW67u","edit-time":1621551394302,":create/user":{":user/uid":"2didgYjql9PA7QKUOsQOD9n84ms1"},":edit/user":{":user/uid":"2didgYjql9PA7QKUOsQOD9n84ms1"}}],"refs":[{"uid":"gLxOqtvIz"}],"uid":"uMaq3ntwX",":block/refs":[{":block/uid":"gLxOqtvIz"}],"string":"{{[[roam/js]]}}",":create/user":{":user/uid":"2didgYjql9PA7QKUOsQOD9n84ms1"},"create-time":1621542937555,":edit/user":{":user/uid":"2didgYjql9PA7QKUOsQOD9n84ms1"}}],"uid":"Tr5jr9ayc","edit-time":1621542932613,":edit/user":{":user/uid":"2didgYjql9PA7QKUOsQOD9n84ms1"}}]